<!DOCTYPE html>
<html lang="en">

<head>
  <title>HomeDing Setup</title>
</head>

<body>
  <h1>HomeDing Setup</h1>
  <h2>Connect to network</h2>
  <table>
    <tr>
      <td>Network:</td>
      <td><select id="conNetworks" style="width:18em"></select></td>
    </tr>
    <tr>
      <td>Passphrase:</td>
      <td><input id="conPass" style="width:18em"></input></td>
    </tr>
  </table>
  <button id="connectPass">Connect</button>
  <script>
    var scanDone = 2;
    var checkTimer = 0;
    var selObj = document.getElementById('conNetworks');

    function load(url, loadCallback) {
      var objHTTP = new XMLHttpRequest(); // new ActiveXObject("MSXML2.XMLHTTP");
      objHTTP.open('GET', url, true);
      objHTTP.addEventListener('readystatechange', function (p) {
        if (objHTTP.readyState == 4) {
          if ((objHTTP.status >= 200) && (objHTTP.status < 300)) {
            loadCallback(objHTTP.responseText);
          } // if
        } // if
      });
      objHTTP.send();
    } // load()

    function startScan() {
      if (scanDone == 2) {
        selObj.innerHTML = '<option selected disabled>scanning...</option>';
        scanDone = 0;
        if (!checkTimer)
          checkTimer = window.setInterval(checkScan, 200);
      }
    } // startScan()

    function checkScan() {
      load('/$scan', function (txt) {
        if (txt.length > 0) {
          scanDone = 2;
          scanResult(JSON.parse(txt));
        }
      });
    } // checkScan()

    function scanResult(netList) {
      window.clearInterval(checkTimer);
      checkTimer = 0;

      selObj.innerHTML = "";

      var o = document.createElement('option');
      o.value = 0;
      o.text = 'select...';
      o.disabled = true;
      selObj.options.add(o);

      netList.forEach(function (n) {
        var o = document.createElement('option');
        o.value = o.text = n.id;
        selObj.options.add(o);
      });
    } // scanResult()

    // connect using network name and password
    document.getElementById('connectPass').addEventListener('click', function () {
      load('/$connect?n=' + selObj.value + '&p=' + document.getElementById('conPass').value,
      function () {});
    });
    startScan();
  </script>
</body>