<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="google-site-verification" content="7tTF0t5uCMnyE6X31OIOQpcOf4QxWuODtyZLoVsKCEc" />
  <meta name="msvalidate.01" content="7FC9C7BCD4002EBD89AAC2EF63D7B353" />
  <link rel="icon" type="image/png" href="favicon48.png" sizes="48x48">
  <meta name='description' content=''>
  <title>Element Registry</title>
  <link Content-Type="text/css" href="/docstyle.css" rel="stylesheet" />
  <script src="/pages.js"></script>
</head>

<body scroll="0" style="padding:0;">
  <div class="u-header">
    <a href="/" title="Startpage"><img class="icon" src="/i/default.svg" /></a>
    <h1>HomeDing</h1>
  </div>

  <div class="u-navbar" style="margin-bottom: 0;">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" id="menuButton" class="button" style="height:1.4rem">
      <path fill="white" d="M0 8h48v6H0zm0 13h48v6H0zm0 13h48v6H0z" />
    </svg>

    <a href="/index.htm" class="button">Home</a>
    <a href="/concepts/index.htm" class="button">Concepts</a>
    <a href="/elements/index.htm" class="button">Elements</a>
    <a href="/boards/index.htm" class="button">Boards</a>
    <a href="/recipes/index.htm" class="button">Recipes</a>
  </div>
  <nav class="inpage open"></nav>

  <main style="background-color:#eeeeee;padding:1rem">
    <h1>Element Registry</h1>
<h2>Why we need a registry</h2>
<p>The ElementRegistry is the central class that knows all included and available
Element classes to allow further creation of new Elements by name at runtime.</p>
<p>This allows specifying the <code>known elements</code> at compile time to optimize the programs size  to the available flash memory on the smaller boards but can include all elements for bigger boards.</p>
<p>At runtime the elements not in use will not consume dynamic memory leaving this rare space for the active elements.</p>
<p>In the Sketches using the HomeDing library it is not required to define the active Elements you need.
It is possible to activate new Elements just by specifying them in the env.json or config.json.</p>
<p>Therefore the Element classes are <em>known</em> and every Element class has a static function that can be called to create a new Element
so to make it life and working.</p>
<p>Element implementations should not automatically register themselves in some cases.</p>
<ul>
<li>System level elements will register themselves any time (like device and ota).</li>
<li>Core elements can be included all together or individually.</li>
<li>Optional elements can be included individually.</li>
</ul>
<h2>Using Elements for configuration</h2>
<p>Some elements only exist to capture configuration properties. Most of them specific system related features like the devicename or the available hardware.</p>
<p>Examples are:</p>
<ul>
<li><a href="/elements/device.htm">Device</a></li>
<li><a href="/elements/displays.htm">Displays</a></li>
<li><a href="/elements/ota.htm">OTA</a></li>
<li><a href="/elements/ssdp.htm">SSPD</a></li>
</ul>
<p>Most of these elements don't use actions to communicate.</p>
<h3>Complex Elements and Huge Elements</h3>
<p>When an Element implementation needs very much program memory so even when no Element is configured this memory is occupied.</p>
<h3>Elements with compiletime dependencies</h3>
<p>Some elements rely on a the functionality given by an external library. You may consider not including them by compile time.</p>
<p>E.g. it is sufficient to only include the display adapter and the according library that fits to the attached display.</p>
<p>In the <a href="/elements/index.htm">Elements</a> list you can find these Elements marked with the required library.</p>
<h3>System and Core Elements</h3>
<p>Some Elements are almost always helpful, are registered always and can be used without the need for special libraries. These are the System Elements.</p>
<p>Other Elements are lightweight and also need no special libraries. As long as the program memory fits into the flash of your board you can include these libraries at once using the HOMEDING_INCLUDE_CORE definition.</p>
<h2>The Registry Mechanism</h2>
<p>Therefore the HomeDing library has a specific mechanism implemented to allow specifying what Elements are compiled and registered.
This can be seen in all Example Sketches just before the <code>#include &lt;HomeDing.h&gt;</code> statement:</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token comment">// Use all Core Elements of the HomeDing Library</span><br><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">HOMEDING_INCLUDE_CORE</span></span><br><br><span class="token comment">// Use some more Elements that need additional libraries</span><br><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">HOMEDING_INCLUDE_DHT</span></span><br><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">HOMEDING_INCLUDE_DS18B20</span></span><br><br><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;HomeDing.h></span></span></code></pre>
<p>This configuration will include all the core Elements and the individual Element for reading DHT and DS18B20 sensors.</p>
<h2>Build a new Element for your local usage</h2>
<p>It is easy to build a new Element that is required for a specific thing to work. You can just copy one of the existing and modify the class Name
or use the &quot;MyTemplate&quot; example as a starting point.</p>
<p>The intension is that it is easy to add any Element to the Library later so anyone can add new functionality to the HomeDing Library.</p>
<p>When implementing an Element (elements/here: My) for a single project / sketch
the MyElement needs to be registered into the ElementRegistry too (and only once).</p>
<p>As long as the Element is inside the project folder beside the sketch file the registration is placed in the
MyElement.cpp file at the end and looks like this:</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token comment">// Register MyElement in the ElementRegistry.</span><br><span class="token keyword">bool</span> MyElement<span class="token double-colon punctuation">::</span>registered <span class="token operator">=</span><br>    <span class="token class-name">ElementRegistry</span><span class="token double-colon punctuation">::</span><span class="token function">registerElement</span><span class="token punctuation">(</span><span class="token string">"my"</span><span class="token punctuation">,</span> MyElement<span class="token double-colon punctuation">::</span>create<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<h2>Element registration for library Elements</h2>
<p>When transferred to the HomeDing library a <code>#define HOMEDING_INCLUDE_My</code> should be used to allow the sketch to select the available Elements.</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">HOMEDING_REGISTER</span></span><br><span class="token comment">// Register MyElement in the ElementRegistry.</span><br><span class="token keyword">bool</span> MyElement<span class="token double-colon punctuation">::</span>registered <span class="token operator">=</span><br>    <span class="token class-name">ElementRegistry</span><span class="token double-colon punctuation">::</span><span class="token function">registerElement</span><span class="token punctuation">(</span><span class="token string">"my"</span><span class="token punctuation">,</span> MyElement<span class="token double-colon punctuation">::</span>create<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span></code></pre>
<p>You can see the whole list of elements and how they are bundled to some groups in the <code>HomeDing.h</code> include file.</p>
<p>The mechanism to do this relies on a little &quot;trick&quot; by using the assignment of a static variables.</p>
<p>The compiler automatically generates the code to execute this assignment and registration before the sketch starts
and also automatically detects multiple implementations and throws an error.</p>
<h2>See also</h2>
<ul>
<li>
<p>allow registration of Element Types to avoid hard references.<br> <a href="https://www.bfilipek.com/2018/02/factory-selfregister.html">https://www.bfilipek.com/2018/02/factory-selfregister.html</a></p>
</li>
<li>
<p><a href="http://www.drdobbs.com/cpp/self-registering-objects-in-c/184410633">http://www.drdobbs.com/cpp/self-registering-objects-in-c/184410633</a></p>
</li>
<li>
<p><a href="https://stackoverflow.com/questions/5120768/how-to-implement-the-factory-method-pattern-in-c-correctly">https://stackoverflow.com/questions/5120768/how-to-implement-the-factory-method-pattern-in-c-correctly</a></p>
</li>
<li>
<p><a href="https://www.codeproject.com/Articles/363338/Factory-Pattern-in-Cplusplus">https://www.codeproject.com/Articles/363338/Factory-Pattern-in-Cplusplus</a></p>
</li>
</ul>

  </main>

  <script>
    var mbObj = document.querySelector('#menuButton');
    var navObj = document.querySelector('nav');

    mbObj.addEventListener('click', function (e) {
      navObj.classList.toggle('open');
    });
    if (window.innerWidth > 880)
      navObj.classList.add('open');

    lazyLoadHTM('nav', '/toc.htm');
  </script>
  
  </body>

</html>