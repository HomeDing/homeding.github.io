
<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Build a Weather forecast display</title>
    <script src="/pages.js"></script>
    <link content-type="text/css" href="/docstyle.css" rel="stylesheet"/>
    <script src="/story.js" type="module"></script>
    <link rel="icon" type="image/png" href="/favicon48.png" sizes="48x48">
    <meta name='description' content='Examples and documentation for the HomeDing IoT Library'>
    <meta name="google-site-verification" content="7tTF0t5uCMnyE6X31OIOQpcOf4QxWuODtyZLoVsKCEc"/>
    <meta name="msvalidate.01" content="7FC9C7BCD4002EBD89AAC2EF63D7B353"/>
  </head>
  <body scroll="0" style="padding:0;">
    <div class="u-navbar" style="margin-bottom: 0;">
      <svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 48 48" id="menuButton" class="button" style="height:1.4rem">
        <path fill="white" d="M0 8h48v6H0zm0 13h48v6H0zm0 13h48v6H0z"/>
      </svg>
      <a href="/index.htm" class="button">Home</a>
      <a href="/elements/index.htm" class="button">Elements</a>
      <a href="/boards/index.htm" class="button">Boards</a>
      <a href="/recipes/index.htm" class="button">Recipes</a>
    </div>
    <nav></nav>
    <main style="padding:1rem;max-width: 800px;">
      <h1>Build a Weather forecast display</h1>
      
        <p><strong>This is Work in progress</strong> <!-- TODO: --></p>
<p><strong>Table of Contents</strong></p>
<ul>
<li><a href="#intro">Intro</a></li>
<li><a href="#use-the-browser-as-a-remote-information-panel">Use the browser as a remote information panel</a></li>
<li><a href="#supplies">Supplies</a></li>
<li><a href="#prepare-arduino-environment-for-esp8266">Prepare Arduino Environment for ESP8266</a></li>
<li><a href="#install-the-homeding-library">Install the HomeDing Library</a></li>
<li><a href="#customize-the-standard-example-sketch">Customize the standard example sketch</a></li>
<li><a href="#allow-network-access">Allow network access</a></li>
<li><a href="#web-based-upload-of-the-web-ui-files">Web based Upload of the web UI Files</a></li>
<li><a href="#create-the-system-and-display-configuration">Create the system and display configuration</a></li>
<li><a href="#register-at-openweathermap-">Register at openweathermap ???</a></li>
<li><a href="#create-the-configuration-for-a-weather-display">Create the configuration for a weather display</a></li>
<li><a href="#links-and-references">Links and references</a></li>
</ul>
<h2>Intro</h2>
<p>The weather of today is a fact, just look outside or use some sensors.
The weather of tomorrow is relevant for planning.</p>
<p>This is about a device that shows the weather forecast on a display and also allows automation of other devices based on weather forecast information.</p>
<p><img src="/stories/weatherdisp1.jpg" alt="Weather display"></p>
<p>This solution here uses a ESP8266 board and a OLED display. This Material that you can get under 7€.</p>
<p>The software is based on the HomeDing library for IoT devices and the OpenWeather forecast service.
The library also supports looking into the display of the device remotely using a web browser.</p>
<p>The ESP8266 board used here is a combination of a ESP8266 with 4 MByte Flash ram and a 128*32 pixel display.</p>
<ul>
<li>The actual temperature and humidity is taken from a DHT22 sensor attached to the device.</li>
<li>The forecast information is coming from the OpenWeather service. The free version (only registration) is sufficient.</li>
<li>There is the option to use a remote sensor that can be placed e.g. outside using another ESP8266 board.</li>
<li>There is also the option use different displays or sensors as the library is very flexible in using different displays with different chips or different sensors like the BME680 including air pressure.</li>
</ul>
<p>By using the HomeDing library it is easy to build a device that is connected to your home Network only and can be reached and controlled by any browser on the network. It comes with a selection of <code>Elements</code> that allow using the most common sensor chips, devices and other services.</p>
<p>It also brings a complete solution for hosting a web side inside device instead of using a cloud based solution to display the sensor data and interact with the device.</p>
<h2>Use the browser as a remote information panel</h2>
<p>The display content is also available when using a browser and open the Web UI of the device.</p>
<p>The Homeding library provides a web version when opening the http://<devicename>/board.htm:</p>
<p><img src="/stories/weatherboard.png" alt="Weather board screenshot"></p>
<h2>Supplies</h2>
<p>The hardware parts you need to build this project and used in this story are:</p>
<ul>
<li>A <a href="/boards/nodemcu.htm">nodemcu</a> or compatible board with the ESP8266 processor and USB interface.</li>
<li>A OLED display based on a SH1106, SSD1306 or SSD1309 controller chip.</li>
<li>1 USB plug and a micro-usb cable for power supply.</li>
</ul>
<p><img src="/stories/weatherdisp2.jpg" alt="Weather display"></p>
<p>There are boards available that already have both combined like</p>
<ul>
<li>**<a href="/boards/wifikit8.htm">Wifi Kit 8 Module ESP8266 with OLED</a></li>
<li>**<a href="/boards/esp8266/wemos18650.htm">ESP8266 with OLED and 18650</a></li>
<li>**<a href="/boards/wemosoled.htm">ESP8266 with OLED</a></li>
</ul>
<p>The system configuration for these boards can be found on these pages. Here a nodemcu and a discrete display is used.</p>
<h2>Prepare Arduino Environment for ESP8266</h2>
<ol>
<li>
<p>To install latest version of Arduino IDE (currently version 1.8.12) please visit <a href="https://www.arduino.cc/">https://www.arduino.cc/</a>.</p>
</li>
<li>
<p>Download the Arduino IDE for your operating system from the <code>Software -&gt; Download</code> menu.</p>
</li>
<li>
<p>Install the Arduino software and all drivers.</p>
</li>
<li>
<p>Start the Arduino IDE and open the Preferences dialog.</p>
</li>
<li>
<p>Enter <code>https://arduino.esp8266.com/stable/package_esp8266com_index.json</code>
into the <code>Additional Board Manager URLs</code> field. You can add multiple URLs, separating them with commas.</p>
</li>
<li>
<p>Open the menu Boards Manager in the Arduino IDE from the Tools -&gt; Board menu
and find entry <strong>esp8266 by ESP8266 Community</strong> and install the latest version.</p>
</li>
<li>
<p>Use the Board Manager to install the ESP8266 support.</p>
<p>A detailed instruction can be found here: <a href="https://arduino-esp8266.readthedocs.io/en/latest/installing.html#boards-manager">https://arduino-esp8266.readthedocs.io/en/latest/installing.html#boards-manager</a></p>
</li>
<li>
<p>Setup the board options for a NodeMCU 1.0 with 1MByte reserved memory for the File System</p>
</li>
</ol>
<p><img src="/stories/arduino-boardoptions.png" alt="board options"></p>
<p>Now you are ready to build Arduino projects, edit sketches and upload them to the device.</p>
<h2>Install the HomeDing Library</h2>
<p>Open the Library Manager in Arduino Environment and search for the HomeDing library and install it.</p>
<p>The HomeDing library relies on some common extra libraries for sensors and displays to work. These libraries will be installed automatically as dependencies.</p>
<p><img src="/stories/arduino-libraryinstall.png" alt="Install libraries"></p>
<p>Now the library implementation and the examples are available to be used.</p>
<h2>Customize the standard example sketch</h2>
<p>The <a href="/examples/standard.htm">Standard Example</a> already includes the most common elements for sensors, services, general IO and displays so only some configuration will be required.</p>
<p>This implementation also required the special <a href="/elements/WeatherFeed.htm">WeatherFeed Element</a> for accessing the WeatherFeed service. Therefore the standard example needs to be extended to include this element in the firmware by defining the following constant in the standard.ino sketch file just above the <code>#include &lt;Arduino.h&gt;</code>:</p>
<pre class="language-cpp"><code class="language-cpp"><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">HOMEDING_INCLUDE_WEATHERFEED</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;Arduino.h></span></span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></code></pre>
<h2>Allow network access</h2>
<p><img src="/stories/sketch-secrets.png" alt="Network Secrets in Code"></p>
<p>For simplicity on adding the new device to your home wifi network you may add the SSID and passphrase of your home WiFi
in the <code>secrets.h</code> file next to the <code>standard.ino</code> sketch file.  But you can also use the built-in WiFi Manager to add
the device to the network without this hard-coded configuration.</p>
<p><img src="/stories/sketch-secrets.png" alt="Network Secrets in Code"></p>
<p>If you like to configure the network credentials using the built-in wifi manager you can find a step-by-step description
at <a href="/steps/newdevice.htm">Step by Step Bring your device to work</a> .</p>
<p><img src="/dev/wifimanager.png" alt="WiFi Manager UI"></p>
<p>Now everything regarding implementation of the sketch is done and the firmware can be compiled and uploaded.</p>
<h2>Web based Upload of the web UI Files</h2>
<p>The standard example comes with a <code>data</code> folder that contains all file for the web UI.  These files are also available
in the HomeDing documentation web site and can be transferred by opening the page <code>/$boot.htm</code>.  Use
http://&lt;devicename&gt;/$boot.htm and use the devicename or ip address of your board.</p>
<p>??? devicename example of a fresh device.</p>
<p>The press <code>start</code> and you see the UI files transferred from the web site to the device.</p>
<p>This method is useful when starting with a new board or to update to a new version of the UI files.</p>
<h2>Create the system and display configuration</h2>
<p>The device hardware specific configuration of the board and the display should be placed into the <code>/env.json</code> file. The I2C bus configuration must also be done in this file in the device configuration. Here is a full configuration version for a standard nodemcu board with a SSD1306 / SSD1309 based display:</p>
<pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"device"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"main"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"nodeding"</span><span class="token punctuation">,</span>
      <span class="token property">"description"</span><span class="token operator">:</span> <span class="token string">"nodeMCU board config"</span><span class="token punctuation">,</span>
      <span class="token property">"reboottime"</span><span class="token operator">:</span> <span class="token string">"24h"</span><span class="token punctuation">,</span>
      <span class="token property">"button"</span><span class="token operator">:</span> <span class="token string">"D3"</span><span class="token punctuation">,</span>
      <span class="token property">"led"</span><span class="token operator">:</span> <span class="token string">"D4"</span><span class="token punctuation">,</span>
      <span class="token property">"I2C-SDA"</span><span class="token operator">:</span> <span class="token string">"D2"</span><span class="token punctuation">,</span>
      <span class="token property">"I2C-SCL"</span><span class="token operator">:</span> <span class="token string">"D1"</span><span class="token punctuation">,</span>
      <span class="token property">"safemode"</span><span class="token operator">:</span> <span class="token string">"false"</span><span class="token punctuation">,</span>
      <span class="token property">"loglevel"</span><span class="token operator">:</span> <span class="token string">"2"</span><span class="token punctuation">,</span>
      <span class="token property">"cache"</span><span class="token operator">:</span> <span class="token string">"max-age=600"</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  <span class="token property">"DisplaySSD1306"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"0"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">"address"</span><span class="token operator">:</span> <span class="token string">"60"</span><span class="token punctuation">,</span>
      <span class="token property">"height"</span><span class="token operator">:</span> <span class="token number">64</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  <span class="token property">"ota"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"main"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">"description"</span><span class="token operator">:</span> <span class="token string">"allow Over the Air Updates"</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">"ssdp"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"0"</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<h2>Register at openweathermap ???</h2>
<h2>Create the configuration for a weather display</h2>
<p>The display is used to show some values from the forecast so we need to configure the service parameters, some text output and where to find the information to be displayed in the result from the service.</p>
<p>The following configuration can be used:</p>
<pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"weatherfeed"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"home"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">"host"</span><span class="token operator">:</span> <span class="token string">"api.openweathermap.org"</span><span class="token punctuation">,</span>
      <span class="token property">"get"</span><span class="token operator">:</span> <span class="token string">"/data/2.5/onecall?units=metric&amp;${loc}&amp;exclude=current,hourly&amp;appid=${key}&amp;lang=en"</span><span class="token punctuation">,</span>
      <span class="token property">"key"</span><span class="token operator">:</span> <span class="token string">"&lt;your key here...>"</span><span class="token punctuation">,</span>
      <span class="token property">"loc"</span><span class="token operator">:</span> <span class="token string">"lat=50.23&amp;lon=8.65"</span><span class="token punctuation">,</span>
      <span class="token property">"readtime"</span><span class="token operator">:</span> <span class="token string">"04:00:00"</span><span class="token punctuation">,</span>
      <span class="token property">"actions"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
          <span class="token property">"path"</span><span class="token operator">:</span> <span class="token string">"daily[0]/temp/day"</span><span class="token punctuation">,</span>
          <span class="token property">"onvalue"</span><span class="token operator">:</span> <span class="token string">"displaytext/t0?value=$v"</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
          <span class="token property">"path"</span><span class="token operator">:</span> <span class="token string">"daily[0]/humidity"</span><span class="token punctuation">,</span>
          <span class="token property">"onvalue"</span><span class="token operator">:</span> <span class="token string">"displaytext/h0?value=$v"</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
          <span class="token property">"path"</span><span class="token operator">:</span> <span class="token string">"daily[0]/weather[0]/description"</span><span class="token punctuation">,</span>
          <span class="token property">"onvalue"</span><span class="token operator">:</span> <span class="token string">"displaytext/d0?value=$v"</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
          <span class="token property">"path"</span><span class="token operator">:</span> <span class="token string">"daily[1]/temp/day"</span><span class="token punctuation">,</span>
          <span class="token property">"onvalue"</span><span class="token operator">:</span> <span class="token string">"displaytext/t1?value=$v"</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
          <span class="token property">"path"</span><span class="token operator">:</span> <span class="token string">"daily[1]/humidity"</span><span class="token punctuation">,</span>
          <span class="token property">"onvalue"</span><span class="token operator">:</span> <span class="token string">"displaytext/h1?value=$v"</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
          <span class="token property">"path"</span><span class="token operator">:</span> <span class="token string">"daily[1]/weather[0]/description"</span><span class="token punctuation">,</span>
          <span class="token property">"onvalue"</span><span class="token operator">:</span> <span class="token string">"displaytext/d1?value=$v"</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">"displaytext"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"t0"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">"x"</span><span class="token operator">:</span> <span class="token number">55</span><span class="token punctuation">,</span>
      <span class="token property">"y"</span><span class="token operator">:</span> <span class="token number">16</span><span class="token punctuation">,</span>
      <span class="token property">"fontsize"</span><span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span>
      <span class="token property">"value"</span><span class="token operator">:</span> <span class="token string">"--.--"</span><span class="token punctuation">,</span>
      <span class="token property">"postfix"</span><span class="token operator">:</span> <span class="token string">"°C "</span><span class="token punctuation">,</span>
      <span class="token property">"description"</span><span class="token operator">:</span> <span class="token string">"Display the temp forecast"</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">"h0"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">"x"</span><span class="token operator">:</span> <span class="token number">100</span><span class="token punctuation">,</span>
      <span class="token property">"y"</span><span class="token operator">:</span> <span class="token number">16</span><span class="token punctuation">,</span>
      <span class="token property">"fontsize"</span><span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span>
      <span class="token property">"postfix"</span><span class="token operator">:</span> <span class="token string">"%"</span><span class="token punctuation">,</span>
      <span class="token property">"value"</span><span class="token operator">:</span> <span class="token string">"--"</span><span class="token punctuation">,</span>
      <span class="token property">"description"</span><span class="token operator">:</span> <span class="token string">"Display the hum forecast"</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">"d0"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">"x"</span><span class="token operator">:</span> <span class="token number">8</span><span class="token punctuation">,</span>
      <span class="token property">"y"</span><span class="token operator">:</span> <span class="token number">26</span><span class="token punctuation">,</span>
      <span class="token property">"fontsize"</span><span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span>
      <span class="token property">"value"</span><span class="token operator">:</span> <span class="token string">"txt"</span><span class="token punctuation">,</span>
      <span class="token property">"description"</span><span class="token operator">:</span> <span class="token string">"Display the forecast description"</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">"t1"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">"x"</span><span class="token operator">:</span> <span class="token number">55</span><span class="token punctuation">,</span>
      <span class="token property">"y"</span><span class="token operator">:</span> <span class="token number">41</span><span class="token punctuation">,</span>
      <span class="token property">"fontsize"</span><span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span>
      <span class="token property">"value"</span><span class="token operator">:</span> <span class="token string">"##.##"</span><span class="token punctuation">,</span>
      <span class="token property">"postfix"</span><span class="token operator">:</span> <span class="token string">"°C "</span><span class="token punctuation">,</span>
      <span class="token property">"description"</span><span class="token operator">:</span> <span class="token string">"Display the temp forecast"</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">"h1"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">"x"</span><span class="token operator">:</span> <span class="token number">100</span><span class="token punctuation">,</span>
      <span class="token property">"y"</span><span class="token operator">:</span> <span class="token number">41</span><span class="token punctuation">,</span>
      <span class="token property">"fontsize"</span><span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span>
      <span class="token property">"postfix"</span><span class="token operator">:</span> <span class="token string">"%"</span><span class="token punctuation">,</span>
      <span class="token property">"value"</span><span class="token operator">:</span> <span class="token string">"##.##"</span><span class="token punctuation">,</span>
      <span class="token property">"description"</span><span class="token operator">:</span> <span class="token string">"Display the hum forecast"</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">"d1"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">"x"</span><span class="token operator">:</span> <span class="token number">8</span><span class="token punctuation">,</span>
      <span class="token property">"y"</span><span class="token operator">:</span> <span class="token number">51</span><span class="token punctuation">,</span>
      <span class="token property">"fontsize"</span><span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span>
      <span class="token property">"value"</span><span class="token operator">:</span> <span class="token string">"txt"</span><span class="token punctuation">,</span>
      <span class="token property">"description"</span><span class="token operator">:</span> <span class="token string">"Display the forecast description"</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>The <code>weatherfeed</code> element is configured to call the given url by using the location and key parameter. As a key you need to use your personal key as described in the <a href="http://openweathermap.org">openweathermap.org</a> documentation. Here also the information mapping is configured.</p>
<p>The values themselves will be “pushed” by the the <code>weatherfeed</code> element to the displaytext elements using actions.</p>
<p>The <code>displayText</code> elements are used to display the information given by the actions from the <code>weatherfeed</code> element.</p>
<h2>Links and references</h2>
<ul>
<li>HomeDing Source Code Repository: <a href="https://github.com/HomeDing/HomeDing">https://github.com/HomeDing/HomeDing</a></li>
<li>HomeDing Documentation: <a href="https://homeding.github.io/">https://homeding.github.io/</a></li>
<li><a href="/examples/standard.htm">Standard Example</a></li>
<li><a href="/elements/dht.htm">The DHT Element</a></li>
<li><a href="/elements/WeatherFeed.htm">WeatherFeed Element</a></li>
<li><a href="/elements/pms.htm">PMS Element</a></li>
<li><a href="/elements/log.htm">Log Element</a></li>
<li><a href="/elements/ntptime.htm">NPTTime Element</a></li>
<li>Display</li>
<li>DisplayText</li>
</ul>

        
          <h2>Tags</h2>
          <div class="taglist">
            
              <a href="/tag/story.htm">Story</a>
            
              <a href="/tag/wip.htm">Wip</a>
            
          </div>
        
      </main>
      <script>
        const param = {
          MENU_MIN_WIDTH: 1030
        };
        var mbObj = document.querySelector('#menuButton');
        var navObj = document.querySelector('nav');
        if (window.innerWidth > param.MENU_MIN_WIDTH) { // menu is inside the page
          navObj.classList.add('open');
          navObj.classList.add('inpage');
        }
        mbObj.addEventListener('click', function (e) {
          navObj.classList.toggle('open');
        });
        lazyLoadHTM('nav', '/toc.htm');
      </script>

      <script type="module" async>
        import mermaid from "https://unpkg.com/mermaid@10/dist/mermaid.esm.min.mjs";
        document.addEventListener('DOMContentLoaded', mermaid.initialize({startOnLoad: true}));
      </script>

    </body>
  </body>
</html>