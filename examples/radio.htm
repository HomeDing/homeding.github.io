
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Radio Example</title>
  <script src="/pages.js"></script>
  <link content-type="text/css" href="/docstyle.css" rel="stylesheet"/>
  <script src="/story.js" type="module"></script>
  <link rel="icon" type="image/png" href="/favicon48.png" sizes="48x48">
  <meta name='description' content='Examples and documentation for the HomeDing IoT Library'>
  <meta name="google-site-verification" content="7tTF0t5uCMnyE6X31OIOQpcOf4QxWuODtyZLoVsKCEc"/>
  <meta name="msvalidate.01" content="7FC9C7BCD4002EBD89AAC2EF63D7B353"/>
</head>

<body class="sitelayout" style="--content-width:800px">
  <div class="navbar">
    <svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 48 48" id="menuButton" class="button" style="height:1.4rem">
      <path fill="white" d="M0 8h48v6H0zm0 13h48v6H0zm0 13h48v6H0z"/>
    </svg>
    <a href="/index.htm" class="button">Home</a>
    <a href="/elements/index.htm" class="button">Elements</a>
    <a href="/boards/index.htm" class="button">Boards</a>
    <a href="/recipes/index.htm" class="button">Recipes</a>
  </div>
  
  <nav style="background-color:white"></nav>

  <main>
    <h1>Radio Example</h1>

    
      <div class="card-container horizontal text" style="--card-height:5rem;--card-image-size:5rem;">
        <div class="card">
          
          <div class="body">
            <p>The <strong>radio example</strong> can be used with any board that has a 4MByte Flash memory, a FM radio receiving board, a display and a rotary encoder with button.</p>

          </div>
        </div>
      </div>
    

    <p>In addition some wiring for amplifier and speaker or headphone connectors are required to create a full functional and remote controllable radio.</p>
<h2>Setup the development environment and board</h2>
<p>If this is the first time you use an ESP8266 board, some instructions on how to setup your development environment can be found here:</p>
<p><a href="/steps/arduinosetup.htm">Step by Step setting up a development environment</a></p>
<p>There are some options in uploading the required software and registration on the network that s described here:</p>
<p><a href="/steps/newdevice.htm">Step by Step Bring your device to work</a></p>
<p>This includes:</p>
<ul>
<li>Upload the sketch and Web UI</li>
<li>Connect to the network</li>
<li>Upload the Web UI files</li>
</ul>
<p>After flashing the software and the web files the web interface is fully functional but not yet configured.</p>
<p>To ensure that all tools work as expected the <a href="/examples/standard.htm">Standard example</a> should be used first.</p>
<h2>Components for the Radio Example</h2>
<p>By default the radio example shows how to build a internet connected device
that has a dedicated element for controlling a RDA5807 FM radio chip and a TPA2016 chip that is a stereo amplifier with a volume control.</p>
<p>There are other chips supported by the radio library and some of them also provide volume control. To re-configure the example for SI473x chips see below.</p>
<p>The used components and the principle wiring can be seen in this block diagram:</p>
<p><img src="/examples/radioblocks.png" alt="Radio Building Blocks"></p>
<h2>Wiring</h2>
<p>The chips and the LCD all are connected using the I2C bus. This is used to drive the display and to control the radio and the amplifier functionality.</p>
<p>The rotary encoder is directly connected to the ESP8266 board.</p>
<p>The audio signals are analog and must be   connected from the radio chip to the amplifier board. The speakers are connected to the amplifier board and the antenna to the radio board.</p>
<p>The following table contains all signal lines including the pin numbers:</p>
<table>
<thead>
<tr>
<th>Signal</th>
<th>ESP8266</th>
<th>LCD</th>
<th>Radio</th>
<th>Amp</th>
</tr>
</thead>
<tbody>
<tr>
<td>I2C Data</td>
<td>D2</td>
<td>Data</td>
<td></td>
<td></td>
</tr>
<tr>
<td>I2C Clock</td>
<td>D3</td>
<td>CLK</td>
<td>#4</td>
<td>#5</td>
</tr>
<tr>
<td>VCC 3.3</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>VCC 5</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>GND</td>
<td>GND</td>
<td>GND</td>
<td>#4</td>
<td>#5</td>
</tr>
</tbody>
</table>
<h2>Pictures</h2>
<ul>
<li>The board and other hardware required for this example.
<img src="/examples/radio.jpg" alt="radio"></li>
<li>The unconnected main board and amplifier board.
<img src="/examples/radio2.jpg" alt="radio"></li>
<li>Closer picture of the FM chip.
<img src="/examples/radio3.jpg" alt="radio"></li>
</ul>
<h2>Board and Hardware to build the example</h2>
<p>The following hardware is required for building all of this example:</p>
<ul>
<li>A NodeMCU board with ESP8266</li>
<li>A radio chip like the RDA5807 that can receive FM and is controllable using the I2C bus</li>
<li>A mobile phone headset (at minimum) or</li>
<li>An amplifier and speakers.</li>
<li>The TPA2016 amplifier chip is supported as well by this example</li>
<li>Some buttons for input or a rotary encoder</li>
<li>A display like the LCD</li>
</ul>
<p>The element configuration that is used in this example are:</p>
<ul>
<li>rotary encoder or digitalin element</li>
<li>menu element</li>
<li>value elements</li>
</ul>
<h2>Power supply</h2>
<p>I strongly propose to add a separate power source for the amplifier and the radio chip and not use the power from the Esp8266 board. The USB bus cannot provide much power and the <em>noise</em> on the USB power is usually bad for audio.</p>
<p>You also risk to burn the Regulator on the ESP board.</p>
<h2>Elements in use</h2>
<p>The elements that come with the example code are</p>
<ul>
<li>radio element</li>
<li>TPA2016 element</li>
</ul>
<p>These elements also show how elements can be implemented together with the sketch and are extending the capabilities of the device without the need to include them into the library.</p>
<h2>Using a Rotary encoder</h2>
<p>Using a rotary encoder is a good option to combine a twist and push input using 3 digital inputs to achieve a good usability.</p>
<p><img src="/examples/rotary.jpg" alt="rotary encoder">
<img src="/examples/rotaryside.jpg" alt="rotary encoder side">
<img src="/examples/rotaryback.jpg" alt="rotary encoder back"></p>
<p>In the pictures you can see how the encoder is connected using a self-made PCB that provides a connector for later easy assembling. The connector has the push button and the 2 rotary signals all closing to a common ground signal.</p>
<p>When using the closing to ground approach the builtin pull up resistors of the chip can be used instead of a external resistor.</p>
<ul>
<li>push-button =&gt; D7</li>
<li>rotary1 =&gt; D6</li>
<li>ground =&gt; GND</li>
<li>rotary2 =&gt; D5</li>
</ul>
<p>When the turn is in the wrong direction you just have to switch the two rotary signals.</p>
<h2>Alternative use up and down buttons</h2>
<p>???</p>
<p>Long press the buttons to create repeated up and down actions.</p>
<p>???</p>
<h2>Using the LCD</h2>
<p>The LCD is one of the standard display types that is used in many Arduino solutions. Here a backpack is added to allow using the LCD display on the I2C bus.</p>
<p>The LCD uses 5V power but accepts 3.3 V signals in the I2C bus.</p>
<p><img src="/examples/lcd.jpg" alt="LCD">
<img src="/examples/lcdback.jpg" alt="LCD"></p>
<ul>
<li>GND =&gt; GND (black)</li>
<li>VCC =&gt; VIN (red) (the 5V directly connected to the USB adapter)</li>
<li>SDA =&gt; D2 (blue)</li>
<li>SCL =&gt; D1 (yellow)</li>
</ul>
<p>The text on the display is using several displaytext elements to show the actual values of frequency, volume and RSSI.</p>
<p>The text in the second line is used by the menu element and for showing the station name from RDS.</p>
<h2>Base PCB</h2>
<p>I do not need many radios so I decided to use a prototype PCB as the base. Just large enough to hold all mechanically together.</p>
<p><img src="/examples/board.jpg" alt="board">
<img src="/examples/board2.jpg" alt="board view 2"></p>
<h2>Radio board</h2>
<p>The RDA radio board is not following the typical 2.54 grid but has 2mm spacing connectors.
By using the wires the way you can see on the pictures the board can be soldered to the base PCB.
The wires on top are still visible during assembly for robustness and are later cut away (before applying power).
I added a 100nF capacitor next to the radio.</p>
<p><img src="/examples/rda.jpg" alt="radio chip">
<img src="/examples/rda2.jpg" alt="radio chip">
<img src="/examples/100nf.jpg" alt="100nF capacitor"></p>
<pre class="language-text"><code class="language-text">// http://lcddevice/$board/radio/r?volume=1
// http://lcddevice/$board/radio/r?volume=12
// http://lcddevice/$board/board/0?loglevel=1
// http://lcddevice/$board/radio/r?softmute=0
// http://lcddevice/$board/radio/r?softmute=1

// http://lcddevice/$board/value/frequency?value=10390
// http://lcddevice/$board/value/frequency?value=8930
// http://lcddevice/$board/value/frequency?value=9560
// http://lcddevice/$board/value/frequency?value=9440</code></pre>
<h2>Example configuration</h2>
<pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"rotary"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"0"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">"description"</span><span class="token operator">:</span> <span class="token string">"Rotary Input"</span><span class="token punctuation">,</span>
      <span class="token property">"pin1"</span><span class="token operator">:</span> <span class="token string">"D5"</span><span class="token punctuation">,</span>
      <span class="token property">"pin2"</span><span class="token operator">:</span> <span class="token string">"D6"</span><span class="token punctuation">,</span>
      <span class="token property">"step"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
      <span class="token property">"onchange"</span><span class="token operator">:</span> <span class="token string">"value/frequency?up=$v"</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">"digitalin"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"0"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">"description"</span><span class="token operator">:</span> <span class="token string">"vol up"</span><span class="token punctuation">,</span>
      <span class="token property">"pin"</span><span class="token operator">:</span> <span class="token string">"D7"</span><span class="token punctuation">,</span>
      <span class="token property">"invert"</span><span class="token operator">:</span> <span class="token string">"true"</span><span class="token punctuation">,</span>
      <span class="token property">"pullup"</span><span class="token operator">:</span> <span class="token string">"true"</span><span class="token punctuation">,</span>
      <span class="token property">"onhigh"</span><span class="token operator">:</span> <span class="token string">"value/volume?up=1"</span><span class="token punctuation">,</span>
      <span class="token property">"onlow"</span><span class="token operator">:</span> <span class="token string">"value/volume?up=1"</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">"value"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"volume"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">"min"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
      <span class="token property">"max"</span><span class="token operator">:</span> <span class="token number">15</span><span class="token punctuation">,</span>
      <span class="token property">"value"</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
      <span class="token property">"onchange"</span><span class="token operator">:</span> <span class="token string">"radio/r?volume=$v"</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">"frequency"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">"min"</span><span class="token operator">:</span> <span class="token number">8700</span><span class="token punctuation">,</span>
      <span class="token property">"max"</span><span class="token operator">:</span> <span class="token number">10800</span><span class="token punctuation">,</span>
      <span class="token property">"step"</span><span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span>
      <span class="token property">"value"</span><span class="token operator">:</span> <span class="token number">8930</span><span class="token punctuation">,</span>
      <span class="token property">"onchange"</span><span class="token operator">:</span> <span class="token string">"radio/r?frequency=$v"</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">"menu"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"0"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">"loglevel"</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
      <span class="token property">"onValue"</span><span class="token operator">:</span> <span class="token string">"device/0?log=menu-v:$v"</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">"radio"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"r"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">"description"</span><span class="token operator">:</span> <span class="token string">"A Radio"</span><span class="token punctuation">,</span>
      <span class="token property">"loglevel"</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
      <span class="token property">"volume"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
      <span class="token property">"onVolume"</span><span class="token operator">:</span> <span class="token string">"displaytext/v?value=$v"</span><span class="token punctuation">,</span>
      <span class="token property">"onFrequency"</span><span class="token operator">:</span> <span class="token string">"displaytext/f?value=$v"</span><span class="token punctuation">,</span>
      <span class="token property">"onStationName"</span><span class="token operator">:</span> <span class="token string">"displaytext/text?value=$v"</span><span class="token punctuation">,</span>
      <span class="token property">"onRDSText"</span><span class="token operator">:</span> <span class="token string">"device/0?log=text:$v"</span><span class="token punctuation">,</span>
      <span class="token property">"onRSSI"</span><span class="token operator">:</span> <span class="token string">"displaytext/rssi?value=$v"</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">"displaytext"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"f"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">"x"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
      <span class="token property">"y"</span><span class="token operator">:</span> <span class="token number">0</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">"v"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">"x"</span><span class="token operator">:</span> <span class="token number">8</span><span class="token punctuation">,</span>
      <span class="token property">"y"</span><span class="token operator">:</span> <span class="token number">0</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">"rssi"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">"x"</span><span class="token operator">:</span> <span class="token number">12</span><span class="token punctuation">,</span>
      <span class="token property">"y"</span><span class="token operator">:</span> <span class="token number">0</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">"text"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">"x"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
      <span class="token property">"y"</span><span class="token operator">:</span> <span class="token number">1</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<h2>See also</h2>
<ul>
<li><a href="/dev/i2c.htm">Using the I2C bus</a></li>
</ul>


      
        <h2>Tags</h2>
        <div class="taglist"><a href="/tag/example.htm">Example</a></div>
      
  </main>

  <script>
    var mbObj = document.querySelector('#menuButton');
    var navObj = document.querySelector('nav');
    mbObj.addEventListener('click', function (e) {
      navObj.classList.toggle('open');
    });
    lazyLoadHTM('nav', '/toc.htm');
  </script>

  <script type="module" async>
    import mermaid from "https://unpkg.com/mermaid@10/dist/mermaid.esm.min.mjs";
    document.addEventListener('DOMContentLoaded', mermaid.initialize({startOnLoad: true}));
  </script>

</body>
</html>