<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="google-site-verification" content="7tTF0t5uCMnyE6X31OIOQpcOf4QxWuODtyZLoVsKCEc" />
  <meta name="msvalidate.01" content="7FC9C7BCD4002EBD89AAC2EF63D7B353" />
  <link rel="icon" type="image/png" href="favicon48.png" sizes="48x48">
  <title>Time display using a TM1627 display and brightness control</title>
  <meta name='description' content='Time display with the brightness control.'>
  <link Content-Type="text/css" href="/docstyle.css" rel="stylesheet" />
  <script src="/pages.js"></script>
  <script src="/story.js" type="module"></script>
  <style>
  .gpio { 
    display:inline-block;
    padding: 0 4px;
    border-radius: 4px;
    }
  .gpio.yellow {background-color: #FF0;}
  .gpio.red {background-color: #F22; color:white}
  .gpio.black {background-color: #111; color:white}
  .gpio.blue {background-color: #22F; color:white}
  main h2 {margin-top: 1rem !important;}
  </style>
</head>

<body scroll="0" style="padding:0;">
  <div class="u-navbar" style="margin-bottom: 0;">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" id="menuButton" class="button" style="height:1.4rem">
      <path fill="white" d="M0 8h48v6H0zm0 13h48v6H0zm0 13h48v6H0z" />
    </svg>

    <a href="/index.htm" class="button">Home</a>
    <a href="/elements/index.htm" class="button">Elements</a>
    <a href="/boards/index.htm" class="button">Boards</a>
    <a href="/recipes/index.htm" class="button">Recipes</a>
  </div>

  <nav></nav>

  <main style="padding:1rem;max-width: 800px;">
    <h1>Time display using a TM1627 display and brightness control</h1>

    
      
    <p>A 4-digit 7-segment display with the tm1637 chip to display the current time.
This display is not a full featured display and can display a single value only.
It is configured using the <a href="/elements/tm1637.htm">TM1637 Element</a>.</p>
<p>The time is updated by the <a href="/elements/time.htm">Time Element</a> every minute.</p>
<p>The current time is retrieved from an NTP sever on the internet using the <a href="/elements/ntptime.htm">NtpTime Element</a>.</p>
<p>Here an additional <a href="/elements/value.htm">Value Element</a> is used to control the brightness of a display.</p>
<p>The <a href="/elements/state.htm">RTCState Element</a> is used save the current brightness value for a reboot.</p>
<p><img src="/recipes/ntpclock2.jpg" alt="image" title="w600"></p>
<ul>
<li>In <strong>env.json</strong> the system is configured to get the time.</li>
<li>In <strong>config.json</strong> the display and control element and actions are configured.</li>
</ul>
<h2>Setup the Display</h2>
<p>You need to add a <a href="/elements/ntptime.htm">NTPtime Element</a> to the configuration in <strong>env.json</strong>.</p>
<p>You need to add a <a href="/elements/time.htm">Time Element</a> and a [TM1627 Element] to the configuration in <strong>config.json</strong>.</p>
<p>Here the display is connected using the GPIO pins D6 for the clock signal and the D7 for the data signal.
The GND and 5.0 V must be connected too.</p>
<h2>Setup the Time</h2>
<p>The <a href="/elements/ntptime.htm">NTPTime Element</a> configures the ESP8266 system to use a ntp server from the internet to get the current time.
This time always returns the greenwich time (GMT).
A configuration is required to calculate the local time that includes the name of the local timezone and the offset to GMT.
If there is a “summertime” period, the start and end of that period can be configured as well.</p>
<p>The POSIX format for this configuration is explained here: <a href="https://developer.ibm.com/technologies/systems/articles/au-aix-posix/">https://developer.ibm.com/technologies/systems/articles/au-aix-posix/</a>.</p>
<p>Examples for timezones can be found in <a href="https://sites.google.com/a/usapiens.com/opnode/time-zones">https://sites.google.com/a/usapiens.com/opnode/time-zones</a>.</p>
<p>See <a href="https://sites.google.com/a/usapiens.com/opnode/time-zones">https://sites.google.com/a/usapiens.com/opnode/time-zones</a> for examples.</p>
<h2>Time Actions and Output</h2>
<p>The <a href="/elements/time.htm">Time Element</a> can create actions based on the local time. This is used to update the display every minute.</p>
<p>The <strong>ontime</strong> event from the <a href="/elements/time.htm">Time Element</a> send the current time information to the Display element.</p>
<h2>env.json configuration</h2>
<p>A <a href="/elements/ntptime.htm">NTPtime Element</a> is configured to get the current time from a NTP server.</p>
<p>A <a href="/elements/state.htm">State Element</a>, here the RTCState Element, is added to store the current brightness value in
a non volatile memory that keeps the last brightness as long as power is supplied.</p>
<pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  ...
  <span class="token property">"ntptime"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"0"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">"NTPServer"</span><span class="token operator">:</span> <span class="token string">"pool.ntp.org"</span><span class="token punctuation">,</span>
      <span class="token property">"zone"</span><span class="token operator">:</span> <span class="token string">"CET-1CEST,M3.5.0,M10.5.0/3"</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">"rtcstate"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"0"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<h2>config.json configuration</h2>
<p>A 4 digit 7-segment display with the tm1637 chip is defined to display the current time.</p>
<p>The time is updated by the time element every minute.</p>
<p>A brightness value can be configured with initial values.
By using the useState property this element persists its value in the state memory.
The current value is stored to rtc memory and will be available after a restart
as long as power to the board has not been interrupted.</p>
<pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"tm1637"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"0"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"Time Display"</span><span class="token punctuation">,</span>
      <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"tm1637"</span><span class="token punctuation">,</span>
      <span class="token property">"clockpin"</span><span class="token operator">:</span> <span class="token string">"D6"</span><span class="token punctuation">,</span>
      <span class="token property">"datapin"</span><span class="token operator">:</span> <span class="token string">"D7"</span><span class="token punctuation">,</span>
      <span class="token property">"brightness"</span><span class="token operator">:</span> <span class="token string">"1"</span><span class="token punctuation">,</span>
      <span class="token property">"value"</span><span class="token operator">:</span> <span class="token string">"--:--"</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">"time"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"clock"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">"onminute"</span><span class="token operator">:</span> <span class="token string">"tm1637/0?value=$v"</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">"value"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"bright"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"Brightness"</span><span class="token punctuation">,</span>
      <span class="token property">"useState"</span><span class="token operator">:</span> <span class="token string">"true"</span><span class="token punctuation">,</span>
      <span class="token property">"min"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
      <span class="token property">"max"</span><span class="token operator">:</span> <span class="token number">8</span><span class="token punctuation">,</span>
      <span class="token property">"value"</span><span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">,</span>
      <span class="token property">"onvalue"</span><span class="token operator">:</span> <span class="token string">"tm1637/0?brightness=$v"</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<h2>See also</h2>
<ul>
<li><a href="/recipes/ntpclock.htm">NTP Clock with OLED</a> - Display the current time and date from the internet time service.</li>
</ul>


    
    <h2>Tags</h2>
    <div class="taglist"><a href="/tag/recipe.htm">Recipe</a></div>
    
  </main>

  <script>
    const param = {
      MENU_MIN_WIDTH: 1030
    };

    var mbObj = document.querySelector('#menuButton');
    var navObj = document.querySelector('nav');

   if (window.innerWidth > param.MENU_MIN_WIDTH) {
      // menu is inside the page
      navObj.classList.add('open');
      navObj.classList.add('inpage');
    }

    mbObj.addEventListener('click', function (e) {
      navObj.classList.toggle('open');
    });

    lazyLoadHTM('nav', '/toc.htm');
  </script>
  
  </body>

</html>