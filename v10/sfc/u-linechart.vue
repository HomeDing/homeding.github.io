<template><svg xmlns='http://www.w3.org/2000/svg'viewBox='0 0 144 48'><defs><marker id='arrow'markerWidth='10'markerHeight='10'refX='0'refY='3'orient='auto'markerUnits='strokeWidth'viewBox='0 0 20 20'><path d='M0,0 L0,6 L9,3 z'fill='#f00'/></marker><marker id='circle'markerWidth='4'markerHeight='4'refX='2'refY='2'><circle cx='2'cy='2'r='2'stroke='none'fill='#444444'/></marker></defs><g id='axis'transform='matrix(1,0,0,-1,0,48)'><line x1='12'y1='4'x2='12'y2='44'/><line x1='8'y1='8'x2='140'y2='8'/></g><g id='v-labels'transform='matrix(1,0,0,-1,0,41)'></g><g id='h-labels'transform='matrix(1,0,0,-1,12,44)'></g><g id='panel'transform='matrix(1,0,0,-1,12,40)'><rect class='panel-back'width='128'height='36'/></g><g id='ind'transform='matrix(1,0,0,-1,12,40)'style='display:none'><line x1='12'y1='0'x2='12'y2='36'/><circle cx='12'cy='8'r='1.2'/><g class='info'transform='translate(4, 12)'><rect class='back'width='18'height='10'/><text x='1'y='-7'id='indx'></text><text x='1'y='-4'id='indV1'></text><text x='1'y='-1'id='indV2'></text></g></g></svg></template><style scoped>:host{display:inline-block;height:120px;width:360px;background-color:#fff;--fontSize:3px;--strokeWidth:.2}text{font-family:sans-serif}#axis line{stroke:#008800;stroke-width:.2}#panel line,#panel path,#panel polyline{stroke:black;stroke-width:.2;fill:none}.panel-back{fill:#f8f8f8}#h-labels{text-anchor:middle;font-size:2.5px}line{stroke:#008800;stroke-width:.2}circle{fill:none;stroke:darkgreen;stroke-width:.2}text{transform:scale(1,-1);text-anchor:start;font-size:2.6px}.info .back{fill:white;stroke:black;stroke-width:.1}</style><script>const REGION_WIDTH=128,REGION_HEIGHT=36,TYPE_NUMERIC="num",TYPE_DATE="date",TYPE_TIME="time",TYPE_DATETIME="datetime",BOX_UNDEFINED={left:1/0,right:-1/0,minY:1/0,maxY:-1/0};function outerBox(t,e){var a=t;return a?e&&(a={left:Math.min(t.left,e.left),right:Math.max(t.right,e.right),minY:Math.min(t.minY,e.minY),maxY:Math.max(t.maxY,e.maxY)}):a=e,a}function boxIsValid(t){return isFinite(t.left)&&isFinite(t.right)&&isFinite(t.minY)&&isFinite(t.maxY)}function _calcSteps(t,e){var a,s=e-t,i=Math.pow(10,Math.floor(Math.log10(s))),r={};return a=s<=2*i?i/2:s<=5*i?i:2*i,r.high=Math.ceil(e/a)*a,r.low=Math.floor(t/a)*a,r.step=a,r}function _calcDateSteps(t,e){const a=86400,s=60*new Date(0).getTimezoneOffset();var i,r={},o=e-t;if(o>43200&&o<a)i=21600;else if(o>a&&o<2*a)i=43200;else if(o>2*a&&o<6*a)i=a;else{if(!(o>6*a&&o<14*a))return _calcSteps(t,e);i=2*a}return r.high=Math.ceil(e/i)*i-s,r.low=Math.floor(t/i)*i+s,r.step=i,r}function createSVGNode(t,e,a,s){var i=document.createElementNS("http://www.w3.org/2000/svg",e);return a&&Object.getOwnPropertyNames(a).forEach((function(t){i.setAttribute(t,a[t])})),s&&(i.textContent=s),t.appendChild(i),i}function _removeChilds(t){Array.from(t.childNodes).forEach((function(t){t.remove()}))}function formatValue(t,e){var a=e,s=t.split(":"),i=Number(e);return"num"==s[0]?a=String(i.toFixed(s[1]||0)):"date"==t?a=new Date(1e3*i).toLocaleDateString("de"):"time"==t?a=new Date(1e3*i).toLocaleTimeString("de"):"datetime"==t&&(a=new Date(1e3*i).toLocaleString("de")),a}class GraphBase{type="base";hasData=!1;box;parentObj;drawObj;options={};static compare(t,e){return t.hasData===e.hasData?0:t.hasData?-1:1}constructor(t){this.parentObj=t}setOptions(t){this.options=Object.assign({},this.options,t)}setData(t){this.hasData||console.error("cannot use data in non-data graphs")}extendDataBox(t){return t}clear(){}fDraw(t){this.clear(),this.box=t}}class HAxis extends GraphBase{type="hAxis";options={format:"num",color:"black"};extendDataBox(t){var e;boxIsValid(t)&&(e="date"===this.options.format?_calcDateSteps(t.left,t.right):_calcSteps(t.left,t.right),t.left=e.low,t.right=e.high,this.step=e.step);return t}fDraw(t){if(super.fDraw(t),boxIsValid(t)){var e=this.step,a=e<1?String(e).length-2:0,s=128/(t.right-t.left),i=this.options.format;"num"===i&&(i="num:"+a);for(var r=t.left;r<=t.right;r+=e){var o=formatValue(this.options.format,r).split(",");createSVGNode(this.parentObj,"text",{x:(r-t.left)*s,y:0,style:"fill:"+this.options.color},o[0]),o[1]&&createSVGNode(this.parentObj,"text",{x:(r-t.left)*s,y:3,style:"fill:"+this.options.color},o[1])}}}clear(){super.clear(),_removeChilds(this.parentObj)}}class VAxis extends GraphBase{type="vAxis";options={format:"num",color:"black"};extendDataBox(t){var e=_calcSteps(t.minY,t.maxY);return t.minY=e.low,t.maxY=e.high,this.step=e.step,t}fDraw(t){super.fDraw(t);for(var e=t.maxY,a=t.minY,s=this.step,i=s<1?String(s).length-2:0,r=36/(e-a),o=a;o<=e;o+=s)createSVGNode(this.parentObj,"text",{x:11,y:-1*(o-a)*r},String(Number(o).toFixed(i)))}clear(){super.clear(),_removeChilds(this.parentObj)}}class HLine extends GraphBase{type="HLine";options={color:"red"};extendDataBox(t){return t&&(t.minY=Math.min(this.options.data,t.minY),t.maxY=Math.max(this.options.data,t.maxY)),t}fDraw(t){super.fDraw(t);var e=36/(t.maxY-t.minY),a=(this.options.data-t.minY)*e;this.drawObj=createSVGNode(this.parentObj,"line",{class:"hline",style:"stroke:"+this.options.color,x1:0,y1:a,x2:128,y2:a})}clear(){super.clear(),this.drawObj&&this.drawObj.remove(),this.drawObj=void 0}}class LineGraph extends GraphBase{type="line";options={linetype:"line",color:"black"};hasData=!0;data;#t(t){var e=null;if(t){var a=t.map((function(t){return t.x})),s=t.map((function(t){return t.y}));e={left:Math.min(...a),right:Math.max(...a),minY:Math.min(...s),maxY:Math.max(...s)}}return e}clear(){super.clear(),this.drawObj&&this.drawObj.remove(),this.drawObj=void 0}setData(t){super.setData(t),this.data=t}extendDataBox(t){return outerBox(t,this.#t(this.data))}fDraw(t){super.fDraw(t);var e=this.data;if(e){var a=128/(t.right-t.left),s=36/(t.maxY-t.minY),i=[];if("steps"==this.options.linetype)i=e.map((e=>"H"+(e.x-t.left)*a+" V"+(e.y-t.minY)*s)),i[0]="M"+(e[0].x-t.left)*a+","+(e[0].y-t.minY)*s;else if("line"==this.options.linetype)i=e.map(((e,i)=>(i>0?"L":"M")+(e.x-t.left)*a+","+(e.y-t.minY)*s));else if("bezier"==this.options.linetype){var r=e.map((e=>({x:(e.x-t.left)*a,y:(e.y-t.minY)*s})));const c=e.length;var o=(t.right-t.left)/c/2*a,n=[];n.push({dx:0,dy:0});for(let t=1;t<c-1;t++){var h=r[t+1].x-r[t-1].x,l=r[t+1].y-r[t-1].y,p=Math.sqrt(h*h+l*l);n.push({dx:o*h/p,dy:o*l/p})}n.push({dx:0,dy:0}),i.push("M"+r[0].x+","+r[0].y);for(let t=0;t<c-1;t++)i.push("C"+(r[t].x+n[t].dx)+","+(r[t].y+n[t].dy)+" "+(r[t+1].x-n[t+1].dx)+","+(r[t+1].y-n[t+1].dy)+" "+r[t+1].x+","+r[t+1].y)}var c={class:"chartline",style:"stroke:"+this.options.color,d:i.join("")};this.options.marker&&(c.style+=";marker:url(#circle)"),this.drawObj=createSVGNode(this.parentObj,"path",c)}}}class Indicator extends GraphBase{type="indicator";options={xFormat:"num",yFormat:"num"};#e;#a=()=>{this.drawObj.style.display="none"};#s=t=>{this.#i(t)};constructor(t,e,a){super(t),this.drawObj=e,this.#e=a,t.addEventListener("mouseout",this.#a),t.addEventListener("mousemove",this.#s)}clear(){super.clear(),this.drawObj.style.display="none",this.parentObj.removeEventListener("mouseout",this.#a),this.parentObj.removeEventListener("mousemove",this.#s)}#r(t){var e=this.parentObj.parentElement,a=e.createSVGPoint();return a.x=t.clientX,a.y=t.clientY,a.matrixTransform(e.getScreenCTM().inverse())}#i(t){var e=this.#r(t);const a=this.#e.data;if(a&&a.length){var s=this.#e.box,i=s.left+(e.x-12)*(s.right-s.left)/128,r=a.findIndex((function(t){return t.x>i}));r<0?r=a.length-1:r>0&&a[r].x-i>i-a[r-1].x&&(r-=1);const t=a[r];this.drawObj.style.display="";var o=this.drawObj.querySelector("line"),n=this.drawObj.querySelector("circle"),h=this.drawObj.querySelector(".info"),l=128*(t.x-s.left)/(s.right-s.left),p=(t.y-s.minY)*(36/(s.maxY-s.minY));o.x1.baseVal.value=o.x2.baseVal.value=l,n.cx.baseVal.value=l,n.cy.baseVal.value=p,l+=l<64?2:-20,p+=p<18?1:-11,h.setAttribute("transform","translate("+l+","+p+")");var c=h.querySelectorAll("text");c[0].textContent=formatValue(this.options.yFormat,t.y);var d=formatValue(this.options.xFormat,t.x).split(",");c[1].textContent=d[0],c[2].textContent=d[1]}}}export default class ULineChart extends UComponent{panelObj=this.shadowRoot.getElementById("panel");#o={fontSize:"6px",strokeWidth:.2};#n=Object.assign({},this.#o);graphs=[];indicator=null;clear(){this.graphs.forEach((t=>t.clear())),this.graphs=[],this.indicator&&(this.indicator.clear(),this.indicator=null)}add(t="",e={}){let a;Array.isArray(t)?t.forEach((t=>this.add(t.type,t.options))):("line"===(t=String(t).toLowerCase())?(a=new LineGraph(this.shadowRoot.getElementById("panel")),a.setOptions(e)):"hline"==t?(a=new HLine(this.shadowRoot.getElementById("panel")),a.setOptions(e)):"vaxis"==t?(a=new VAxis(this.shadowRoot.getElementById("v-labels")),a.setOptions(e)):"haxis"==t?(a=new HAxis(this.shadowRoot.getElementById("h-labels")),a.setOptions(e)):"indicator"==t?this.indicator=new Indicator(this.shadowRoot.getElementById("panel"),this.shadowRoot.querySelector("#ind"),this.graphs[0]):console.error("ULine",`unknown graph type '${t}'`),a&&(this.graphs.push(a),this.graphs.sort(((t,e)=>GraphBase.compare(t,e)))))}setOptions(t){this.style.setProperty("--fontSize",this.#n.fontSize),this.style.setProperty("--strokeWidth",this.#n.strokeWidth)}draw(t){var e=this.graphs.find((t=>t.hasData));e&&e.setData(t);var a=this.graphs.reduce((function(t,e){return e.extendDataBox(t)}),BOX_UNDEFINED);this.graphs.forEach((t=>{t.fDraw(a)}))}}</script>