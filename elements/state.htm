<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="google-site-verification" content="7tTF0t5uCMnyE6X31OIOQpcOf4QxWuODtyZLoVsKCEc" />
  <meta name="msvalidate.01" content="7FC9C7BCD4002EBD89AAC2EF63D7B353" />
  <link rel="icon" type="image/png" href="favicon48.png" sizes="48x48">
  <title>Store State</title>
  <meta name='description' content='Examples and documentation for the HomeDing IoT Library'>
  <link Content-Type="text/css" href="/docstyle.css" rel="stylesheet" />
  <script src="/pages.js"></script>
  <script src="/story.js" type="module"></script>
  <style>
  .gpio { 
    display:inline-block;
    padding: 0 4px;
    border-radius: 4px;
    }
  .gpio.yellow {background-color: #FF0;}
  .gpio.red {background-color: #F22; color:white}
  .gpio.black {background-color: #111; color:white}
  .gpio.blue {background-color: #22F; color:white}
  main h2 {margin-top: 1rem !important;}
  </style>
</head>

<body scroll="0" style="padding:0;">
  <div class="u-navbar" style="margin-bottom: 0;">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" id="menuButton" class="button" style="height:1.4rem">
      <path fill="white" d="M0 8h48v6H0zm0 13h48v6H0zm0 13h48v6H0z" />
    </svg>

    <a href="/index.htm" class="button">Home</a>
    <a href="/elements/index.htm" class="button">Elements</a>
    <a href="/boards/index.htm" class="button">Boards</a>
    <a href="/recipes/index.htm" class="button">Recipes</a>
  </div>

  <nav></nav>

  <main style="padding:1rem;max-width: 800px;">
    <h1>Store State</h1>

    
    
      <div class="plaincard">
    
    This element implements storing the current state in some other places as volatile variables.
</div>
      
    <p>The state is a collection of information and values of a device that cannot be found in configuration.</p>
<p>When a IoT device is starting up it can use the values from the configuration if the elements
like the current value of a switch that controls the light or power.</p>
<p>That is a situation that normally changes over time because e.g. a light may be switched or a
schedule may be adjusted.
When the device is switched off and on or was just restarted it is obvious that the latest
actual values of these elements should be present as these values are more accurate than the values
that can be found in the configuration files.</p>
<p>This set of information in application architecture is called the “state”
and starting with version 1.0 of the HomeDing library there is a mechanism
to implement the behavior described above.</p>
<h2>State Elements</h2>
<p>There are multiple <strong>State Elements</strong> that implement the actual storage mechanism.
When such an Element is configured it registers
itself in the board class and offer their functionality to all other elements.</p>
<p>All other Elements can then pass values to the registered State element to be saved by using the save() function. State Elements will collect these values in the format of actions and will update the current list of state actions in the storage.</p>
<p>When a device is re-starting the state element will create actions to update the given values in the elements.
This is done just after the initialization from the configuration files and before the elements get started.</p>
<p>As of now there are 2 State Elements available that can be enabled by configuring them in the <code>env.json</code> configuration.
They actually do not participate in the actions but register a state storage mechanism for other elements.</p>
<h3>RTC State</h3>
<p>The RTCStateElement registers itself for saving the state information in the RTC Memory that is available in the ESP8266 processor. Here state survives reboots and software updates as long as the power of the device is not switched off.</p>
<p>The following configuration enables this state mechanism:</p>
<pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"rtcstate"</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token property">"0"</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>There is not much space in the RTC Memory and only 200 characters can be used to store the state information.</p>
<p>The state is formatted as a series of actions like:</p>
<pre class="language-json"><code class="language-json"><span class="token string">"switch/power?value=1,value/speed?value=12"</span></code></pre>
<h3>EEPROM State</h3>
<p>t.b.d.</p>
<h2>Elements with State</h2>
<p>There are multiple Elements that support saving and loading state:</p>
<p>value, switch</p>
<p>To enabled saving and loading the state of an Element the <code>useState</code> property must be enabled.</p>
<p>Here is an example for a switch supporting 0 and 1 values. The default value is <code>0</code> == Off while the value after a reboot is taken from the state memory.</p>
<pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"switch"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"power"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">"value"</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span>
      <span class="token property">"useState"</span><span class="token operator">:</span><span class="token number">1</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<!-- 
[](https://www.dweet.io/play/)


https://www.balena.io/

https://temboo.com/
https://temboo.com/arduino
https://temboo.com/arduino/others/update-google-spreadsheet


https://alternativeto.net/software/dweet-io/?license=free -->
<h2>See also</h2>
<ul>
<li>RTC Memory functions: <a href="https://arduino-esp8266.readthedocs.io/en/latest/libraries.html#esp-specific-apis">https://arduino-esp8266.readthedocs.io/en/latest/libraries.html#esp-specific-apis</a></li>
</ul>


    
    <h2>Tags</h2>
    <div class="taglist"><a href="/tag/element.htm">Element</a></div>
    
  </main>

  <script>
    const param = {
      MENU_MIN_WIDTH: 1030
    };

    var mbObj = document.querySelector('#menuButton');
    var navObj = document.querySelector('nav');

   if (window.innerWidth > param.MENU_MIN_WIDTH) {
      // menu is inside the page
      navObj.classList.add('open');
      navObj.classList.add('inpage');
    }

    mbObj.addEventListener('click', function (e) {
      navObj.classList.toggle('open');
    });

    lazyLoadHTM('nav', '/toc.htm');
  </script>
  
  </body>

</html>