
<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="google-site-verification" content="7tTF0t5uCMnyE6X31OIOQpcOf4QxWuODtyZLoVsKCEc"/>
    <meta name="msvalidate.01" content="7FC9C7BCD4002EBD89AAC2EF63D7B353"/>
    <link rel="icon" type="image/png" href="favicon48.png" sizes="48x48">
    <title>BL0937 Element</title>
    <meta name='description' content='Support the HLW8012 and BL0937 chip for single phase energy monitoring.'>
    <link content-type="text/css" href="/docstyle.css" rel="stylesheet"/>
    <script src="/pages.js"></script>
    <script src="/story.js" type="module"></script>
  </head>
  <body scroll="0" style="padding:0;">
    <div class="u-navbar" style="margin-bottom: 0;">
      <svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 48 48" id="menuButton" class="button" style="height:1.4rem">
        <path fill="white" d="M0 8h48v6H0zm0 13h48v6H0zm0 13h48v6H0z"/>
      </svg>
      <a href="/index.htm" class="button">Home</a>
      <a href="/elements/index.htm" class="button">Elements</a>
      <a href="/boards/index.htm" class="button">Boards</a>
      <a href="/recipes/index.htm" class="button">Recipes</a>
    </div>
    <nav></nav>
    <main style="padding:1rem;max-width: 800px;">
      <h1>BL0937 Element</h1>
      
        
            <div class="plaincard">
            
            The BL0937Element has been implemented to support single phase energy monitoring using BL0937, HLW8012 or HJL-01 chips that are used in some retail plugs and switches.

          </div>
        
        <p>All of these chips work the same by sending pulse signals that represent voltage, current and power. They have the same chip layout and pins.
As they directly work with the main power signals, only using some resistors to reduce high voltage and high current they are not intended to be used on DIY IoT devices.
The HLW8012 is an older model while the HJL-01/BL0937 is a newer more stable version.</p>
<div class="warning"><h3>Warning</h3>
<ul>
<li>This warning is serious.</li>
<li>Never handle projects that are connected to the mains voltage.</li>
<li>Stay away from devices with contact to mains voltage.</li>
<li>Uploading firmware to devices that have contact to mains voltage is dangerous.</li>
<li>DO NOT connect the any device to the mains during flashing or while using the serial interface.</li>
<li>You may kill your computer and yourself.</li>
<li>The USB-Serial adapters offer enough power to flash the device.</li>
<li>When you are making these kind of projects you really need to know what you are doing.</li>
<li>I have warned you, do not blame on me.</li>
</ul>
</div>
<p>The chip is directly working on the power line signals by measuring voltages and current. This part of the chip is lined out in detail in the datasheet.
From this measurements the chip creates 38 micro seconds pulses on 2 pins that need to be captured by the microprocessor.</p>
<p>These chips can monitor power consumption side by side to monitoring either current or voltage.</p>
<p>The timing of these impulses will be used to calculate the power consumption, actual current and actual voltage. A device specific factor needs to be provided for all the calculations.</p>
<h2>Web UI for the BL0937 Element</h2>
<p>There is a dedicated card for this element available that shows the actual measured values and can switch between voltage and current mode.</p>
<p><img src="/elements/bl0937ui.png" alt="BL0937 Sensor UI"></p>
<h2>Element Configuration</h2>
<p><object data="/element.svg?bl0937" type="image/svg+xml"></object></p>
<p>The following properties are available for configuration of the element:</p>
<blockquote>
<p><strong>selpin</strong>* – Specifies the GPIO pin that is used to select current or voltage mode.</p>
<p><strong>cfpin</strong>*  – Specifies the GPIO pin that is used to capture the cf signal from the chip for power consumption.</p>
<p><strong>cf1pin</strong>* – Specifies the GPIO pin that is used to capture the cf signal from the chip for current or voltage.</p>
<p><strong>mode</strong> – specifies wether the current or the voltage mode should be used.</p>
<p><strong>cycletime</strong> – The cycletime defines the time in milliseconds that is used to collect impulses. The default is set to 2 seconds (2000 milliseconds) good for load &gt; 10W.
When having lower loads this time may be set to use longer time to count impulses.</p>
<p><strong>powerfactor</strong> – This factor defines pulse density to power in W.</p>
<p><strong>currentfactor</strong> – This factor defines pulse density to current in mA.</p>
<p><strong>voltagefactor</strong> – This factor defines pulse density to voltage in V.</p>
<p><strong>poweradjust</strong> – This action uses the given power value to calculate the power factor.</p>
<p><strong>currentadjust</strong> – This action uses the given current value to calculate the current factor.</p>
<p><strong>voltageadjust</strong> – This action uses the given voltage value to calculate the voltage factor.</p>
<p><strong>onVoltage</strong> – These actions are emitted by the element when a new voltage value was measured.</p>
<p><strong>onCurrent</strong> – These actions are emitted by the element when a new current value was measured.</p>
<p><strong>onPower</strong> – These actions are emitted by the element when a new power value was measured.</p>
<p><strong>onEnergy</strong> – These actions are emitted by the element when a new energy value was measured.</p>
</blockquote>
<p>From the base element implementation the following properties are available for configuration:</p>
<blockquote>
<p><strong>title</strong> – Caption text for the element. Used by the element specific cards on the dash boards.</p>
<p><strong>description</strong> – A line of text that gives a short description of the device used in the web UI.</p>
<p><strong>room</strong> – The location of the device.</p>
<p><strong>loglevel</strong> – This property holds the element specific log level. The default value is LOGGER_LEVEL_ERR == 1.</p>
</blockquote>
<p>* These properties are mandatory</p>
<h3>Configuration Example</h3>
<p>This example shows how to configure this element:</p>
<pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"bl0937"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"0"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">"loglevel"</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
      <span class="token property">"cycletime"</span><span class="token operator">:</span> <span class="token string">"1000"</span><span class="token punctuation">,</span>
      <span class="token property">"selpin"</span><span class="token operator">:</span> <span class="token string">"D6"</span><span class="token punctuation">,</span>
      <span class="token property">"cfpin"</span><span class="token operator">:</span> <span class="token string">"D1"</span><span class="token punctuation">,</span>
      <span class="token property">"cf1pin"</span><span class="token operator">:</span> <span class="token string">"D2"</span><span class="token punctuation">,</span>
      <span class="token property">"mode"</span><span class="token operator">:</span> <span class="token string">"voltage"</span><span class="token punctuation">,</span>
      <span class="token property">"powerfactor"</span><span class="token operator">:</span> <span class="token string">"1346829.38"</span><span class="token punctuation">,</span>
      <span class="token property">"currentfactor"</span><span class="token operator">:</span> <span class="token string">"1346829.38"</span><span class="token punctuation">,</span>
      <span class="token property">"voltagefactor"</span><span class="token operator">:</span> <span class="token string">"1346829.38"</span><span class="token punctuation">,</span>
      <span class="token property">"onpower"</span><span class="token operator">:</span> <span class="token string">"displaytext/p?value=$v"</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<h2>Element State</h2>
<p>The following properties are available with the current values at runtime</p>
<blockquote>
<p><strong>active</strong> – Is set to true when the Element is active.</p>
<p><strong>cycletime</strong> – The actual cycletime for counting pulses.</p>
<p><strong>mode</strong> – The actual mode for cf1 pulses.</p>
<p><strong>power</strong> – The actual  power value.</p>
<p><strong>powerfactor</strong> – The actual used factor.</p>
<p><strong>current</strong> – The actual current value when current mode is active.</p>
<p><strong>currentfactor</strong> – The actual used factor.</p>
<p><strong>voltage</strong> – The actual voltage value when voltage mode is active.</p>
<p><strong>voltagefactor</strong> – The actual used factor.</p>
<p><strong>energy</strong> – The actual voltage value when voltage mode is active.</p>
</blockquote>
<h3>Example State</h3>
<pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"bl0937/0"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"active"</span><span class="token operator">:</span><span class="token string">"true"</span><span class="token punctuation">,</span><span class="token property">"cycletime"</span><span class="token operator">:</span><span class="token string">"1000"</span><span class="token punctuation">,</span><span class="token property">"mode"</span><span class="token operator">:</span><span class="token string">"voltage"</span><span class="token punctuation">,</span>
    <span class="token property">"power"</span><span class="token operator">:</span><span class="token string">"120"</span><span class="token punctuation">,</span><span class="token property">"powerfactor"</span><span class="token operator">:</span><span class="token string">"1346829.38"</span><span class="token punctuation">,</span>
    <span class="token property">"current"</span><span class="token operator">:</span><span class="token string">"435"</span><span class="token punctuation">,</span><span class="token property">"voltagefactor"</span><span class="token operator">:</span><span class="token string">"129059.00"</span><span class="token punctuation">,</span>
    <span class="token property">"energy"</span><span class="token operator">:</span><span class="token string">"52.83"</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<h2>Supported retail devices</h2>
<p>There are some devices available using the ESP8266 processor and one of these energy monitoring chips:</p>
<blockquote>
<ul>
<li>Sonoff POW Power Monitoring Switch</li>
<li>BlitzWolf BW-SHP6 10A</li>
<li>BlitzWolf BW-SHP6 15A</li>
<li>Gosund SP111 Power Monitoring Plug</li>
<li>BlitzWolf BW-SHP2 Power Monitoring Plug</li>
<li>Nous A1, Nous A1T Smart WiFi Socket</li>
</ul>
</blockquote>
<p>Many of them are manufactured by Tuya and re-branded.</p>
<p>When you find your device in the Template list at <a href="https://templates.blakadder.com/all.html">https://templates.blakadder.com/all.html</a>
and its functionality mentions a BL0937 or HLW8012 chip like the
<a href="https://templates.blakadder.com/gosund_SP111.html">https://templates.blakadder.com/gosund_SP111.html</a> it is likely to be supported by this element.</p>
<p>Here you can also detect the GPIOs used connecting to the chip (SEL, CF, CF1).</p>
<h2>Calibration</h2>
<p>Most devices with these chips differ in the accuracy of the pulses. Therefore to get good results the default factors should overwritten in the configuration.</p>
<p>The get the device specific factors a reference load is required where the power consumption is known or use another good power measuring tool.
The best results are given by pure resistor loads like classic light bulbs. Here a 100W light is used.</p>
<ul>
<li>call <a href="http://socket01/api/state/bl0937/0?cycletime=5000">http://socket01/api/state/bl0937/0?cycletime=5000</a> to create a more precise pulse monitoring 5 sec cycles can be used.</li>
<li>call <a href="http://socket01/api/state/bl0937/0?mode=voltage">http://socket01/api/state/bl0937/0?mode=voltage</a></li>
<li>Switch on and wait some cycles (30secs).</li>
<li>call <a href="http://socket01/api/state/bl0937/0?poweradjust=100">http://socket01/api/state/bl0937/0?poweradjust=100</a> to adjust the powerfactor</li>
<li>call <a href="http://socket01/api/state/bl0937/0?voltageadjust=226">http://socket01/api/state/bl0937/0?voltageadjust=226</a> to adjust the voltagefactor</li>
<li>calculate the current in mA using the formula current = watt/voltage*1000</li>
<li>call <a href="http://socket01/api/state/bl0937/0">http://socket01/api/state/bl0937/0</a> and see the powerfactor and voltagefactor</li>
<li>call <a href="http://socket01/api/state/bl0937/0?mode=current">http://socket01/api/state/bl0937/0?mode=current</a></li>
<li>Wait some cycles (30secs).</li>
<li>call <a href="http://socket01/api/state/bl0937/0?currentadjust=435">http://socket01/api/state/bl0937/0?currentadjust=435</a></li>
<li>call <a href="http://socket01/api/state/bl0937/0">http://socket01/api/state/bl0937/0</a> and see the currentfactor</li>
</ul>
<p>(you may use your device name and adjust the id of the bl0937 element. Here just <code>0</code> was used.)</p>
<p>enter the 3 factors into the configuration.</p>
<h2>How the chip works</h2>
<p><img src="/elements/bl0937pins.png" alt="BL0937 Pins"></p>
<p>To meassure voltage and current the chips are connected via resistors to the main power signals.
A special load resistor is required to measure the current and the resulting voltage over the resistor
is then probed by the chip.</p>
<p>Voltage or current can be measured alternatively but the energy monitoring is active permanently.</p>
<p>The result of the measurement are impulses on the CF (energy) and CF1 (Voltage or Current) pins.</p>
<p>The BL0937 Element captures these pulses using the nanosecond timer to calculate the values.</p>
<table>
<thead>
<tr>
<th>Pin</th>
<th>symbol</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>VDD</td>
<td>Chip power supply (+3.3V):</td>
</tr>
<tr>
<td>2, 3</td>
<td>IP, IN</td>
<td>Input of the current channel with a maximum differential voltage of ±50mV.</td>
</tr>
<tr>
<td>4</td>
<td>VP</td>
<td>Input of the voltage signal with a maximum of ±200mV.</td>
</tr>
<tr>
<td>5</td>
<td>GND</td>
<td>Chip ground.</td>
</tr>
<tr>
<td>6</td>
<td>CF</td>
<td>Actual power frequency pulse output.</td>
</tr>
<tr>
<td>7</td>
<td>CF1</td>
<td>Actual current or voltage high-frequency pulse output.</td>
</tr>
<tr>
<td>8</td>
<td>SEL</td>
<td>current / voltage output selection</td>
</tr>
</tbody>
</table>
<p>The pins CF and CF1 produce signals:</p>
<blockquote>
<p><strong>SEL signal</strong> - This signal is given by the element to the chip to switch between voltage and current measurement. It can be switched by the <code>mode</code> property of the element.</p>
<p><strong>CF signal</strong> - This signal emits pulses where the frequency is proportional to the power consumption.
The maximal frequency is about 6,78 KHz when the limit of the sensor is reached.</p>
<p><strong>CF1 signal</strong> - This signal emits pulses where the frequency is proportional to the current or voltage value to be measured.</p>
</blockquote>
<h2>See also</h2>
<p>Here are some links related to this chip and flushing a plug device.</p>
<ul>
<li>
<p><a href="https://ownsmarthome.de/2019/01/07/der-kleinste-und-beste-smarte-zwischenstecker-mit-leistungsmessung/">https://ownsmarthome.de/2019/01/07/der-kleinste-und-beste-smarte-zwischenstecker-mit-leistungsmessung/</a></p>
</li>
<li>
<p><a href="https://forum.iobroker.net/topic/26468/gosond-sp-111-v1-1-neue-platine">https://forum.iobroker.net/topic/26468/gosond-sp-111-v1-1-neue-platine</a></p>
</li>
<li>
<p><a href="https://blog.moneybag.de/review-gosund-sp-111-die-noch-kleinere-wlan-steckdose/">https://blog.moneybag.de/review-gosund-sp-111-die-noch-kleinere-wlan-steckdose/</a></p>
</li>
<li>
<p><a href="https://blog.moneybag.de/fhem-iobroker-gosund-sp-111-wlan-steckdose-mit-tasmota-oder-espurna-flashen/">https://blog.moneybag.de/fhem-iobroker-gosund-sp-111-wlan-steckdose-mit-tasmota-oder-espurna-flashen/</a></p>
</li>
<li>
<p><a href="https://www.malachisoord.com/2019/11/24/flashing-custom-firmware-on-a-gosund-sp111/">https://www.malachisoord.com/2019/11/24/flashing-custom-firmware-on-a-gosund-sp111/</a></p>
</li>
<li>
<p><a href="https://tasmota.github.io/docs/devices/BlitzWolf-SHP6/">https://tasmota.github.io/docs/devices/BlitzWolf-SHP6/</a></p>
</li>
<li>
<p><a href="https://templates.blakadder.com/gosund_SP111.html">https://templates.blakadder.com/gosund_SP111.html</a></p>
</li>
<li>
<p>How the chip works: <a href="https://www.itead.cc/blog/introducting-the-hlw8012-ic-in-the-sonoff-pow">https://www.itead.cc/blog/introducting-the-hlw8012-ic-in-the-sonoff-pow</a></p>
</li>
<li>
<p>A Arduino Library : <a href="https://github.com/xoseperez/hlw8012">https://github.com/xoseperez/hlw8012</a></p>
</li>
<li>
<p>Tasmota implementation: <a href="https://github.com/arendst/Tasmota/blob/development/tasmota/xnrg_01_hlw8012.ino">https://github.com/arendst/Tasmota/blob/development/tasmota/xnrg_01_hlw8012.ino</a></p>
</li>
<li>
<p>Another implementation <a href="https://github.com/MacWyznawca/HLW8012_BL0937_ESP">https://github.com/MacWyznawca/HLW8012_BL0937_ESP</a></p>
</li>
<li>
<p>Tasmota supported devices <a href="https://templates.blakadder.com/all.html">https://templates.blakadder.com/all.html</a></p>
</li>
</ul>

        
          <h2>Tags</h2>
          <div class="taglist">
            
              <a href="/tag/element.htm">Element</a>
            
          </div>
        
      </main>
      <script>
        const param = {
          MENU_MIN_WIDTH: 1030
        };
        var mbObj = document.querySelector('#menuButton');
        var navObj = document.querySelector('nav');
        if (window.innerWidth > param.MENU_MIN_WIDTH) { // menu is inside the page
          navObj.classList.add('open');
          navObj.classList.add('inpage');
        }
        mbObj.addEventListener('click', function (e) {
          navObj.classList.toggle('open');
        });
        lazyLoadHTM('nav', '/toc.htm');
      </script>
    </body>
  </body>
</html>